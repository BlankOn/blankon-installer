#!/bin/bash

unset GTK_IM_MODULE

LIVEDEVICE=`mount | grep \/lib\/live\/mount\/medium | cut -d" " -f1 | cut -d"/" -f3`

# Check for mounted partition
for i in `mount | grep '/dev/sd' | cut -d' ' -f1 | cut -d'/' -f3`
do
    
    if ! [ -f /postinstall/pass ];then
      if [ ! "x$i" = "x$LIVEDEVICE" ];then
          zenity --info --text="/dev/$i still mounted.\n Please unmount it first." --title="Mounted Partition"
          exit
      fi
    fi
done
if [ -f /postinstall/pass ];then
    echo "Secure post installation"
else
    grep "boot=live" /proc/cmdline
fi
if [ $? -eq 0 -a -x /usr/bin/blankon-installer ];then

    rm -f /run/locale
    chown -R 1000:1000 /run/user/1000/dconf
    
    if [ -f /postinstall/pass ];then
        # If this file exists, then system just rebooted from an installation attempt
        # SECURE_POST_INSTALL envar will continue the installation step
        export SECURE_POST_INSTALL=1		
        sudo -E bash -c 'echo $SECURE_POST_INSTALL' 
    fi
    
    # Check for BIFT instance
    ip a | grep "10.0.2."
    if [ $? -eq 0 ];then
      BIFTADDR="10.0.2.2"
      nc -z $BIFTADDR 2121
      BIFT=`echo $?`
      if [ "x$BIFT" = "x0" ];then
          curl ftp://$BIFTADDR:2121/scenario > /tmp/scenario
          if [ "x$?" = "x0" ];then
              SCENARIO=`cat /tmp/scenario`
              export DEBUG=1		
              export AUTOFILL=1		
              export SCENARIO=$SCENARIO		
              sudo -E bash -c 'echo $DEBUG' 
              sudo -E bash -c 'echo $AUTOFILL' 
              sudo -E bash -c 'echo $SCENARIO' 
          fi
      fi
    fi
    sudo -E nice -n -20 blankon-installer

    # Run post-install script when created by blankon-installer
    if [ -f /tmp/post-install.sh ];then

        CDROMDEVICE=`cat /proc/sys/dev/cdrom/info | grep "drive name" | cut -d":" -f2 | tr -cd "[[:alnum:]]"`
        if [ "x$CDROMDEVICE" = "x$LIVEDEVICE" ];then

            # Create a systemd service to eject DVD after reboot
            cat << @@EOF > $ROOTFS/lib/systemd/system/eject.service
[Unit]
Description=Eject the DVD
Before=final.target
After=shutdown.target
DefaultDependencies=no

[Service]
Type=oneshot
ExecStart=/usr/bin/eject -m
StandardInput=tty-force
StandardOutput=inherit
StandardError=inherit

[Install]
WantedBy=shutdown.target
@@EOF
            # Enable it
            systemctl enable $ROOTFS/lib/systemd/system/eject.service
        
        fi

        # Do reboot
        /tmp/post-install.sh

    fi 

    # Source locale environment variable generated by installer
    if [ -f /run/locale ];then
        . /run/locale
    fi

    # Source timezone environment variable generated by installer
    if [ -f /run/timezone ];then
        . /run/timezone
    fi

fi

export GTK_IM_MODULE=scim
