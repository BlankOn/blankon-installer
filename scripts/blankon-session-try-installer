#!/bin/bash

LIVEDEVICE=`mount | grep \/lib\/live\/mount\/medium | cut -d" " -f1 | cut -d"/" -f3`

# Check for mounted partition
for i in `mount | grep '/dev/sd' | cut -d' ' -f1 | cut -d'/' -f3`
do
    if [ ! "x$i" = "x$LIVEDEVICE" ];then
        zenity --info --text="/dev/$i still mounted.\n Please unmount it first." --title="Mounted Partition"
        exit
    fi
done

grep "boot=live" /proc/cmdline
if [ $? -eq 0 -a -x /usr/bin/blankon-installer ];then

    rm -f /run/locale

    sudo -E nice -n -20 blankon-installer

    # Run post-install script when created by blankon-installer
    if [ -f /tmp/post-install.sh ];then

        CDROOMDEVICE=`cat /proc/sys/dev/cdrom/info | grep "drive name" | cut -d":" -f2 | tr -cd "[[:alnum:]]"`
        if [ $CDROOMDEVICE = $LIVEDEVICE ];then

            # Create a systemd service to eject DVD after reboot
            cat << @@EOF > $ROOTFS/lib/systemd/system/eject.service
[Unit]
Description=Eject the DVD
Before=final.target
After=shutdown.target
DefaultDependencies=no

[Service]
Type=oneshot
ExecStart=/usr/bin/eject -m
StandardInput=tty-force
StandardOutput=inherit
StandardError=inherit

[Install]
WantedBy=shutdown.target
@@EOF
            # Enable it
            systemctl enable $ROOTFS/lib/systemd/system/eject.service
        fi

        # Do reboot
        /tmp/post-install.sh

    fi 

    # Source locale environment variable generated by installer
    if [ -f /run/locale ];then
        . /run/locale
    fi

    # Source timezone environment variable generated by installer
    if [ -f /run/timezone];then
        . /run/timezone
    fi

fi

